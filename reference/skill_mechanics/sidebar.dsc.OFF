# +-------------------------
# |
# | M a g i c   S i d e b a r
# |
# | Provides a working live-updating per-player sidebar!
#
# @author mcmonkey
# @date 2019/03/01
# @denizen-build REL-1679
# @script-version 1.0
#
# Installation:
# 1. Put the script in your scripts folder.
# 2. Edit the config script below to your liking.
# 3. Reload
#
# Usage:
# Type "/sidebar" in-game to toggle the sidebar on or off.
#
# ---------------------------- END HEADER ----------------------------

# ------------------------- Begin configuration -------------------------
sidebar_config:
    type: data
    # How many updates per second (acceptable values: 1, 2, 4, 5, 10)
    per_second: 5
    # Set this to your sidebar title.
    title: ""
    # Set this to the list of sidebar lines you want to display.
    # Start a line with "[scroll:#/#]" to make it automatically scroll
    # with a specified width and scroll speed (characters shifted per second).
    # Note that width must always be less than the line's actual length.
    # There should also be at least one normal line that's as wide as the width, to prevent the sidebar resizing constantly.
    # lines:
    
# ------------------------- End of configuration -------------------------

sidebar_world:
    type: world
    debug: false
    events:
        on delta time secondly:
        - define per_second <script[sidebar_config].data_key[per_second]>
        - define wait_time <element[1].div[<[per_second]>]>
        - define players <server.online_players.filter[has_flag[sidebar_disabled].not]>
        - define title <script[sidebar_config].data_key[title]>
        - repeat <[per_second]>:
            - sidebar title:<[title].parsed>  values:<proc[sidebar_lines_proc]> players:<[players]> per_player
            - wait <[wait_time]>

sidebar_lines_proc:
    type: procedure
    debug: false
    script:
    - define buffs <player.flag[stat.status.buff].keys||<empty>>
    - define debuffs <player.flag[stat.status.debuff].keys||<empty>>
    # - narrate "<[buffs]>" targets:<server.match_player[sirbandersnatch]>
    - define list <list>
    - foreach <[buffs]> as:buff:
        - if <script[initial_stats_data].data_key[stat.status.buff.<[buff]>].contains[icon]>:
            - define buff <&font[steamfront:gui_icon_status]><script[initial_stats_data].data_key[stat.status.buff.<[buff]>.icon]><&r>
       
        # - define list <[list].set[<[buff]>].at[<[loop_index]>]>
        - define list <[list].include[<&sp>]>
        - define list <[list].include[<&sp><[buff]>]>
        - define list <[list].include[<&sp>]>
    - foreach <[debuffs]> as:debuff:
        
        - if <script[initial_stats_data].data_key[stat.status.debuff.<[debuff]>.icon].exists>:
            - define debuff <&font[steamfront:gui_icon_status]><script[initial_stats_data].data_key[stat.status.debuff.<[debuff]>.icon]><&r>
        - define list <[list].include[<&sp>]>
        - define list <[list].include[<[debuff]>]>
        - define list <[list].include[<&sp>]>
        
        # - narrate "<[debuff]> <[loop_index]>" targets:<server.match_player[sirbandersnatch]>
    # - narrate <[list]> targets:<server.match_player[sirbandersnatch]>
    # - narrate <[list]> targets:<server.match_player[sirbandersnatch]>
    # - narrate <[list]>
    - determine <[list]>

sidebar_command:
    type: command
    debug: false
    name: buffs
    usage: /buffs
    description: Toggles your buffs sidebar on or off.
    script:
    - if <player.has_flag[sidebar_disabled]>:
        - flag player sidebar_disabled:!
        - narrate "<&b>Status Effects Sidebar shown."
    - else:
        - flag player sidebar_disabled
        - narrate "<&b>Status Effects Sidebar not shown."
        - wait 1
        - sidebar remove players:<player>


