harm_task:
    type: task
    definitions: attacker|defender
    script:
    - if <[attacker].has_flag[skill.spells.harm.level].not>:
        - flag <[attacker]> skill.spells.harm.level:1
    - define harm_level <[attacker].flag[skill.spells.harm.level]>
    - define hit <[attacker].eye_location.ray_trace[return=entity;fluids=true;nonsolids=true].points_between[<[attacker].eye_location>].distance[0.02].reverse>
    - define extra_damage 0
    - foreach <[hit]> as:something:
        - playeffect effect:crit_magic offset:0.0 at:<[something]> quantity:4
        # - narrate <[something].find.living_entities.within[2]>
        - if <[something].find.living_entities.within[2].exclude[<[attacker]>].size> > 0:
            # - narrate <red><[something].find.living_entities.within[2]>
            - define target <[something].find.living_entities.within[2].exclude[<[attacker]>].first>
            - define distance_modifier <element[100].sub[<[attacker].location.distance[<[target].location>]>].max[0]>
            - if <[harm_level]> > 10 && <[harm_level]> < 50:
                - define extra_damage <util.random.int[0].to[<[distance_modifier]>]>
            - else if <[harm_level]> > 49 && <[harm_level]> < 100:
                - define extra_damage <util.random.int[1].to[<[distance_modifier].add[1]>]>
            - else if <[harm_level]> > 99:
                - define extra_damage <util.random.int[11].to[<[distance_modifier].add[11]>].add[2]>
            - run spell_damage_task def:harm|<[target]>|<[attacker]>|<[extra_damage]>
            - if <[attacker].has_flag[skill.spells.harm.level]> && <[attacker].flag[skill.spells.harm.level]> > 0 && <[defender].has_flag[skills.skills.constitution.level]> && <[defender].flag[skills.skills.constitution.level]> > 0:
                
                - if <[harm_level]> > 6 && <util.random.int[1].to[2]> == 2:
                    - flag <[defender]> skill.skills.constitition.level:-:<[harm_level]>
                    - wait <util.random.int[2].to[<[harm_level]>].add[2]>s
                    - flag <[defender]> skill.skills.constitition.level:+:<[harm_level]>
            
            - stop
           
    # - shoot <entity[snowball].with[item=harm_entity_item]> origin:<[attacker].eye_location.forward[3]> speed:1 no_rotate shooter:<[attacker]> script:harm_projectile_task save:harm
    # - playeffect effect:crit_magic offset:0.05 at:<player.eye_location.ray_trace[entities=*;ignore=<player>;fluids=true;nonsolids=true;return=precise;default=air].points_between[<player.eye_location>].distance[0.02]> quantity:4
    # - narrate "casting harm"
    # - define distance <[attacker].location.distance[<[defender].location>].round>
    # - define max_damage <[attacker].flag[skill.harm.level].div[<[distance]>].round_up>
    # - define damage <util.random.int[1].to[<[max_damage]>]>
    # - if <[distance]> == 1:
    #     - define damage <[damage].mul[<[attacker].flag[skill.harm.level]>]>
    # - run spell_damage_task def:harm|<[defender]>|<[attacker]>|<[damage]>

# harm_entity_item:
#     type: item
#     script:
#     - define harm