charm_task:
    type: task
    script:
    - if <player.has_flag[skill.charm.level]>:
        - if !<player.item_in_hand.script.data_key[item_type].contains[instrument]>:
            - narrate "You need an instrument in your hand to cast this spell"
            - stop
    - else:
        - narrate "You need a Charm spell level of at least 1."
    - define target <player.target>
    
    - define level <player.flag[skill.charm.level]||1>
    - if <player.has_flag[skill.natural.musicianship_level]>:
        - define music_level <player.flag[skill.natural.musicianship_level]>
    - else:
        - flag <player> skill.natural.musicianship_level:1

    - if <proc[natural_skill_check_proc].context[<player>|musicianship|<[level]>]>:
        - if <[target].as_player.has_flag[charmed]>:
            - narrate "This target is already charmed."
        - else:
            - narrate "Casting charm"
            - flag <[target].as_player> charmed
            - define willpower_amount <util.random.int[1].to[<[level].add[1]>]>
            - define persuade_amount <util.random.int[1].to[<[level]>]>
            - narrate "<player.name>'s song has weakened your willpower." targets:<[target].as_player>
            - flag <[target].as_player>  skill.natural.willpower_level:-:<[willpower_amount]>
            - flag <player> skill.natural.persuasion_level:+:<[persuade_amount]>
            - narrate "Your target has been charmed."
            - wait <[level].add[1]>s
            - flag <[target].as_player>  skill.natural.willpower_level:+:<[willpower_amount]>
            - flag <player> skill.natural.persuasion_level:-:<[persuade_amount]>
            - flag <[target].as_player> charmed:!
            - narrate "Charm has worn off." targets: <[target].as_player>


            
            # - flag <[target]> party:!
        - else:
            - narrate "The target has successfully avoided your influence."
            - if <[target].flag[skill.natural.perception_level]> >= <util.random.int[0].to[50]>:
                - narrate "You hear a song that is trying to weaken your resolve." targets:<[target]>
        
    - else:
        - narrate "You failed to cast charm."
        - if <[target].flag[skill.natural.perception_level]> >= <util.random.int[0].to[50]>:
            - narrate "You hear a song that is trying to weaken your resolve." targets:<[target]>
    - run raise_natural_skill_task def:<player>|musicianship
    - run raise_natural_skill_task def:<player>|magery
    - run raise_natural_skill_task def:<player>|persuasion
    - run raise_natural_skill_task def:<[target]>|willpower